import React, { useEffect, useRef, useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  Alert,
  Linking,
  ActivityIndicator,
  Animated,
} from "react-native";
import axios from "axios";
import { Ionicons } from "@expo/vector-icons";

const API = "https://infallible-dust.onrender.com/api";

export default function BookingScreen({ route, navigation }) {
  const { token, rideId: initialRideId, vehicleType, baseFare, tax } = route.params;

  const [rideId, setRideId] = useState(initialRideId || null);
  const [ride, setRide] = useState(null);
  const [loading, setLoading] = useState(true);

  const intervalRef = useRef(null);
  const driverX = useRef(new Animated.Value(40)).current;

  useEffect(() => {
    Animated.loop(
      Animated.sequence([
        Animated.timing(driverX, { toValue: 260, duration: 3000, useNativeDriver: false }),
        Animated.timing(driverX, { toValue: 40, duration: 3000, useNativeDriver: false }),
      ])
    ).start();
  }, []);

  useEffect(() => {
    if (rideId) {
      fetchRide();
      intervalRef.current = setInterval(fetchRide, 5000);
    } else {
      requestRide(); // create ride if not provided
    }
    return () => clearInterval(intervalRef.current);
  }, [rideId]);

  const requestRide = async () => {
    try {
      const res = await axios.post(
        `${API}/rides/request`,
        { vehicleType, baseFare, tax },
        { headers: { Authorization: `Bearer ${token}` } }
      );
      setRideId(res.data.ride.id);
      setRide(res.data.ride);
      setLoading(false);
    } catch (err) {
      console.log(err);
      Alert.alert("Error", "Failed to request ride");
      setLoading(false);
    }
  };

  const fetchRide = async () => {
    if (!rideId) return;
    try {
      const res = await axios.get(`${API}/rides/${rideId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      setRide(res.data.ride);
      setLoading(false);
    } catch (err) {
      console.log(err);
    }
  };

  const callDriver = () => {
    if (!ride?.driver?.phone) return Alert.alert("Unavailable", "Driver phone not available");
    Linking.openURL(`tel:${ride.driver.phone}`);
  };


  const messageDriver = () => {
    if (!ride?.driver?.phone) return Alert.alert("Unavailable", "Driver phone not available");
    Linking.openURL(`sms:${ride.driver.phone}`);
  };

  const cancelRide = async () => {
    try {
      await axios.post(
        `${API}/rides/cancel`,
        { rideId },
        { headers: { Authorization: `Bearer ${token}` } }
      );
      Alert.alert("Ride Cancelled");
      navigation.navigate("Home");
    } catch {
      Alert.alert("Error", "Failed to cancel ride");
    }
  };

  if (loading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#007bff" />
        <Text>{ride ? "Updating ride..." : "Requesting ride..."}</Text>
      </View>
    );
  }

  const driver = ride?.driver;
  const eta = driver ? `${Math.floor(Math.random() * 10) + 3} min away` : null;
  const finalFare = ride?.finalAmount ?? ride?.total ?? 0;

  return (
    <View style={styles.container}>
      {/* MAP PLACEHOLDER */}
      <View style={styles.map}>
        {driver && (
          <Animated.View style={{ position: "absolute", left: driverX, top: 140 }}>
            <Ionicons name="car" size={28} color="#007aff" />
          </Animated.View>
        )}
        <Text style={{ textAlign: "center", marginTop: 140 }}>üó∫Ô∏è Map Placeholder</Text>
        {driver && <Text style={{ textAlign: "center", marginTop: 10 }}>{driver.name} is on the way</Text>}
      </View>

      
      <View style={styles.card}>
        <Text style={styles.status}>
          {driver ? `‚úÖ Driver assigned ‚Ä¢ ${eta}` : "Searching for driver..."}
        </Text>

        {driver && (
          <>
            <Text style={styles.driverName}>{driver.name}</Text>
            <Text style={styles.driverDetails}>
              {driver.car} ‚Ä¢ ‚≠ê {driver.rating}
            </Text>
          </>
        )}

        <Text style={styles.fare}>Trip Fare: ‚Çπ{finalFare}</Text>
        <Text style={styles.payment}>
          Vehicle: {ride?.vehicleType || "AUTO"} | Payment: {ride?.paymentMethod || "WALLET"}
        </Text>

        {driver && (
          <View style={styles.buttonsRow}>
            <TouchableOpacity style={styles.button} onPress={callDriver}>
              <Text style={styles.buttonText}>Call</Text>
            </TouchableOpacity>
            <TouchableOpacity style={styles.button} onPress={messageDriver}>
              <Text style={styles.buttonText}>Message</Text>
            </TouchableOpacity>
          </View>
        )}

        <TouchableOpacity style={styles.cancelButton} onPress={cancelRide}>
          <Text style={styles.cancelText}>Cancel Ride</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: "#eee" },
  loadingContainer: { flex: 1, justifyContent: "center", alignItems: "center" },
  map: { width: "100%", height: 300, backgroundColor: "#ddd", justifyContent: "center" },
  card: { backgroundColor: "#fff", padding: 20, borderTopLeftRadius: 20, borderTopRightRadius: 20 },
  status: { fontWeight: "bold", color: "green", marginBottom: 6 },
  driverName: { fontSize: 18, fontWeight: "bold" },
  driverDetails: { fontSize: 14, color: "#555", marginBottom: 10 },
  fare: { fontSize: 16, fontWeight: "bold" },
  payment: { fontSize: 14, marginBottom: 10 },
  buttonsRow: { flexDirection: "row", justifyContent: "space-between", marginTop: 10 },
  button: { backgroundColor: "#007bff", padding: 12, borderRadius: 10, flex: 0.48 },
  buttonText: { color: "#fff", textAlign: "center", fontWeight: "bold" },
  cancelButton: { marginTop: 15 },
  cancelText: { color: "red", textAlign: "center", fontWeight: "bold" },
});
